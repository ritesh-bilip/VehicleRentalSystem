{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">Book a Ride</h2>
  <form method="post" id="bookingForm">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary w-100">Book Ride</button>
  </form>

  <!-- Map Section -->
  <div id="map" style="height:400px; width:100%;" class="mt-4"></div>
  <p class="mt-3"><strong>Distance:</strong> <span id="distanceText">--</span></p>
  <p><strong>Estimated Price:</strong> ₹<span id="priceText">--</span></p>
</div>

<script>
  // 1. Initialize map
  var map = L.map('map').setView([22.5726, 88.3639], 12);

  // 2. Add OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // 3. Routing control (empty initially)
  var control = L.Routing.control({
    waypoints: [],
    routeWhileDragging: true
  }).addTo(map);

  // 4. Function to geocode addresses using Nominatim
  async function geocode(address) {
    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${address}`);
    const data = await response.json();
    if (data.length > 0) {
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    }
    return null;
  }

  // 5. Calculate route when form fields change
  async function calculateRoute() {
    const pickup = document.getElementById("id_pickup_location").value;
    const destination = document.getElementById("id_destination").value;
    const vehicle = document.getElementById("id_preference").value;

    if (pickup && destination) {
      const pickupCoords = await geocode(pickup);
      const destCoords = await geocode(destination);

      if (pickupCoords && destCoords) {
        control.setWaypoints([
          L.latLng(pickupCoords[0], pickupCoords[1]),
          L.latLng(destCoords[0], destCoords[1])
        ]);
      }
    }
  }

  // 6. Update distance & price when route is found
  control.on('routesfound', function (e) {
    var distanceKm = e.routes[0].summary.totalDistance / 1000;
    var vehicle = document.getElementById("id_preference").value;
    let pricePerKm = (vehicle === "car") ? 15 : (vehicle === "bike") ? 8 : 25;
    let totalPrice = distanceKm * pricePerKm;

    document.getElementById("distanceText").innerText = distanceKm.toFixed(2) + " km";
    document.getElementById("priceText").innerText = totalPrice.toFixed(2);
  });

  // 7. Event listeners
  document.getElementById("id_pickup_location").addEventListener("blur", calculateRoute);
  document.getElementById("id_destination").addEventListener("blur", calculateRoute);
  document.getElementById("id_preference").addEventListener("change", calculateRoute);
</script>
{% endblock %}